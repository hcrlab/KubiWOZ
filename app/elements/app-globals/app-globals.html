<link rel="import" href="../../../bower_components/polymer/polymer.html">

<polymer-element name="app-globals">
  <script>
    (function () {
      Array.prototype.remove = function() {
        var what, a = arguments, L = a.length, ax;
        while (L && this.length) {
          what = a[--L];
          while ((ax = this.indexOf(what)) !== -1) {
            this.splice(ax, 1);
          }
        }
        return this;
      };

      var fb = new Firebase('https://hcrkubi.firebaseio.com/');

      var data = {
        ids: [],
        current: null
      };

      var initialized = false;

      var callbacks = {};
      var currCallbacks = {};

      Polymer({
        observe: {
          'data.ids': 'idsUpdated',
          'data.current': 'currentUpdated'
        },

        ready: function() {
          this.data = data;

          if(!initialized) {
            initialized = true;

            var that = this;

            fb.on('child_added', function(snap) {
              var child = snap.val();
              that.data.ids.push(snap.V.path.o[0]);
            }, function(error) {
              console.log("Error getting device IDs!");
            });

            fb.on('child_changed', function(snap) {
              var child = snap.val();
              if(!child.connected) {
                that.data.ids.remove(snap.V.path.o[0]);
              } else {
                that.data.ids.push(snap.V.path.o[0]);
              }
            }, function(error) {
              console.log("Error getting device IDs!");
            });

            fb.on('child_removed', function(snap) {
              that.data.ids.remove(snap.V.path.o[0]);
            }, function(error) {
              console.log("Error getting device IDs!");
            });
          }
        },

        setListener: function(key, callback) {
          callbacks[key] = callback;
        },

        idsUpdated: function() {
          for(var i in callbacks) {
            if(callbacks.hasOwnProperty(i)) {
              callbacks[i]();
            }
          }
        },

        setCurrentListener: function(key, callback) {
          currCallbacks[key] = callback;
        },

        currentUpdated: function() {
          for(var i in currCallbacks) {
            if(currCallbacks.hasOwnProperty(i)) {
              currCallbacks[i]();
            }
          }
        }
      });
    })();
  </script>
</polymer-element>
